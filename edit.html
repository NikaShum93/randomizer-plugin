<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Рандомайзер</title>
  <link id="fontLink" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #box {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      word-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .flash {
      animation: flashAnim 0.3s ease-in-out;
    }

    @keyframes flashAnim {
      0% { opacity: 0.2; transform: scale(0.9); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
      pointer-events: none;
      animation: sparkleAnim 0.8s linear forwards;
    }

    @keyframes sparkleAnim {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="box"></div>
  <audio id="clickSound" src="sound1.mp3" preload="auto"></audio>

  <script>
    const params = new URLSearchParams(location.search);
    const bgColor = params.get("bgColor") || "#ffffff";
    const bgOpacity = parseFloat(params.get("bgOpacity") || "1");
    const borderColor = params.get("borderColor") || "#000000";
    const borderOpacity = parseFloat(params.get("borderOpacity") || "1");
    const borderWidth = parseInt(params.get("borderWidth") || "2");
    const borderRadius = parseInt(params.get("borderRadius") || "0");
    const fontSize = parseInt(params.get("fontSize") || "24");
    const textColor = params.get("textColor") || "#000000";
    const fontFamily = params.get("fontFamily") || "sans-serif";
    const winText = params.get("winText") || "You did it!";
    const startText = params.get("startText") || "Нажми, чтобы начать";

    const fontForURL = fontFamily.replace(/ /g, "+");
    document.getElementById("fontLink").href =
      "https://fonts.googleapis.com/css2?family=" + fontForURL + "&display=swap";

    const raw = decodeURIComponent(params.get("tasks") || "");
    const tasks = raw.split(/\r?\n/).map(t => t.trim()).filter(Boolean);

    const box = document.getElementById("box");
    box.textContent = startText;
    box.style.backgroundColor = hexToRgba(bgColor, bgOpacity);
    box.style.borderColor = hexToRgba(borderColor, borderOpacity);
    box.style.borderWidth = borderWidth + "px";
    box.style.borderStyle = borderWidth === 0 ? "none" : "solid";
    box.style.borderRadius = borderRadius + "px";
    box.style.fontSize = fontSize + "px";
    box.style.color = textColor;
    box.style.fontFamily = fontFamily;

    const sound = document.getElementById("clickSound");

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function createSparkle(x, y) {
      for (let i = 0; i < 15; i++) {
        const sparkle = document.createElement("div");
        sparkle.className = "sparkle";
        const dx = (Math.random() - 0.5) * 100 + "px";
        const dy = (Math.random() - 0.5) * 100 + "px";
        sparkle.style.left = x + "px";
        sparkle.style.top = y + "px";
        sparkle.style.setProperty("--dx", dx);
        sparkle.style.setProperty("--dy", dy);
        box.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 800);
      }
    }

    let currentIndex = 0;
    box.addEventListener("click", (e) => {
      if (sound) sound.play().catch(() => {});

      box.classList.remove("flash");
      void box.offsetWidth;
      box.classList.add("flash");

      createSparkle(e.offsetX, e.offsetY);

      if (currentIndex < tasks.length) {
        box.textContent = tasks[currentIndex];
        currentIndex++;
      } else {
        box.textContent = winText;
      }
    });
  </script>
</body>
</html>
